Bootstrap: localimage
From: /home/sa_ac1dt/DEVELOP/INSIGNEO/PFIRE/docker-pfire/singularity/images/base_centos8_openmpi_for_pfire.sif

#
# Bind system folders into container folders with writing permissions
# 1) run, exec, shell, and instance start will accept the --bind/-B command-line option to specify bind paths [:dest_in_container[:ro|rw]]
#    -B can be repeated or the paths can be comma separated
# 2) $SINGULARITY_BIND or $SINGULARITY_BINDPATH
#
#

    
%post

    # Setup directory structure
    export SANDBOX=/singularity_sandbox
    mkdir -p $SANDBOX 
    cd ${SANDBOX}

    echo "alias ll='ls -lrath'" >> /etc/.profile
    echo "alias ll='ls -lrath'" >> /etc/.bashrc

	LOCAL_PACKAGES_DIR="/home/sa_ac1dt/DEVELOP/INSIGNEO/PFIRE/docker-pfire/singularity/packages/"
	
	
	
    ###################################################################
	# Install HDF5
	
	HDF5_VERSION="1.8.22"
	wget https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.8/hdf5-1.8.22/src/hdf5-1.8.22.tar.gz
	#tar -zxvf ${LOCAL_PACKAGES_DIR}hdf5-${HDF5_VERSION}.tar.gz
	tar xzf hdf5-${HDF5_VERSION}.tar.gz
	
	cd hdf5-${HDF5_VERSION}
	
	HDF5_ROOT="/opt/HDF5/${HDF5_VERSION}"

    CC=/opt/ompi/bin/mpicc ./configure --enable-parallel --prefix=${HDF5_ROOT}
    make -j 4
    make install
    
    ###################################################################
    echo "Installing PETSc"
    
    #export OMPI_DIR=/opt/ompi
    #export PATH=$OMPI_DIR/bin:$PATH
    #export LD_LIBRARY_PATH=$OMPI_DIR/lib:$LD_LIBRARY_PATH
    #export MANPATH=$OMPI_DIR/share/man:$MANPATH

    export PETSC_ARCH=opt
    export PETSC_VERSION=3.10.5
    export PETSC_DIR=/opt/petsc-${PETSC_VERSION}
    export PETSC_URL=http://ftp.mcs.anl.gov/pub/petsc/release-snapshots/petsc-lite-${PETSC_VERSION}.tar.gz

    mkdir -p /tmp/petsc

    cd /tmp/petsc
    wget -O petsc-lite-${PETSC_VERSION}.tar.gz ${PETSC_URL}

    cd /opt
    tar xzf /tmp/petsc/petsc-lite-${PETSC_VERSION}.tar.gz
    
    #yum install -y hdf5-openmpi-devel hdf5-devel vim 
    #yum install -y mpich-devel hdf5-mpich-devel hdf5-mpich vim mpich
    
    # Compile and install
    cd ${PETSC_DIR}
    CC=mpicc CXX=mpicxx python2 config/configure.py --with-make-np=10  --download-f2cblaslapack  --with-hdf5-dir=${HDF5_ROOT} 
                          
                                              
                           # --download-openmpi    --with-shared-libraries  --with-debugging=0      --with-fc=0
    make -j all
    make check
    pwd
    
    #make install
      
    #export MPI_ROOT=/opt/petsc-3.10.5/opt/
    #export HDF5_ROOT=/opt/petsc-3.10.5/opt/
    #export HDF5_ROOT=${PETSC_DIR}/${PETSC_ARCH}
    
    export MPI_ROOT=${OMPI_DIR}

    export PATH=$PETSC_DIR/bin:$PATH
    export LD_LIBRARY_PATH=$PETSC_DIR/lib:$LD_LIBRARY_PATH
    export MANPATH=$PETSC_DIR/share/man:$MANPATH

    
    ##############################################################
	# Configure mpich environment 
	    # Information about the version of MPICH to use
    #export MPICH_VERSION=3.3.2
    #export MPICH_URL="http://www.mpich.org/static/downloads/$MPICH_VERSION/mpich-$MPICH_VERSION.tar.gz"
    #export MPICH_DIR=/opt/mpich
        
    # Set env variables so we can compile our application
    #export PATH=$MPICH_DIR/bin:$PATH
    #export LD_LIBRARY_PATH=$MPICH_DIR/lib:$LD_LIBRARY_PATH


%runscript    
    alias ll='ls -lrath'